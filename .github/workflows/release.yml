name: Release

on:
  repository_dispatch:
    types: [on-demand-release]
  workflow_dispatch:
    inputs:
      sha:
        description: "Commit SHA to build"
        required: true
        type: string
      draft:
        description: "Create as draft"
        required: false
        default: true
        type: boolean

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: false

jobs:
  create-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      release-id: ${{ steps.create-release.outputs.result }}
      version: ${{ steps.version.outputs.version }}
    steps:
      - uses: actions/checkout@v4
        with:
          repository: haiyon/coinote
          token: ${{ secrets.GH_TOKEN_FOR_CHECKOUT }}
          ref: ${{ github.event.inputs.sha || github.event.client_payload.sha }}

      - name: Extract version
        id: version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Create release
        id: create-release
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { data: release } = await github.rest.repos.createRelease({
              owner: 'haiyon',
              repo: 'coinote-release',
              tag_name: `v${{ steps.version.outputs.version }}`,
              name: `Coinote v${{ steps.version.outputs.version }}`,
              body: 'Download the installer for your platform below.\n\nFor release notes, visit [coinote.app/releases](https://coinote.app/releases).',
              draft: ${{ github.event.inputs.draft || 'true' }},
              prerelease: false,
              target_commitish: 'main'
            })
            return release.id

  build-tauri:
    needs: create-release
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: macos-latest
            args: "--target aarch64-apple-darwin"
            name: macOS Apple Silicon
            rust-target: aarch64-apple-darwin
          - platform: macos-latest
            args: "--target x86_64-apple-darwin"
            name: macOS Intel
            rust-target: x86_64-apple-darwin
          - platform: windows-latest
            args: ""
            name: Windows x64
            rust-target: x86_64-pc-windows-msvc

    name: Build ${{ matrix.name }}
    runs-on: ${{ matrix.platform }}

    steps:
      - uses: actions/checkout@v4
        with:
          repository: haiyon/coinote
          token: ${{ secrets.GH_TOKEN_FOR_CHECKOUT }}
          ref: ${{ github.event.inputs.sha || github.event.client_payload.sha }}

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - uses: oven-sh/setup-bun@v2

      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.rust-target }}

      - uses: swatinem/rust-cache@v2
        with:
          workspaces: "./tauri -> target"
          key: ${{ matrix.platform }}-${{ matrix.rust-target }}

      - uses: actions/setup-go@v5
        with:
          go-version: "1.24"
          cache-dependency-path: graper/go.sum

      - name: Install system dependencies
        if: matrix.platform == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf

      - run: npm ci

      - name: Build Graper
        shell: bash
        working-directory: graper
        run: |
          set -e

          if [[ "${{ matrix.platform }}" == "macos-latest" ]]; then
            [[ "${{ matrix.rust-target }}" == "aarch64-apple-darwin" ]] && GOARCH=arm64 || GOARCH=amd64
            GOOS=darwin
            BINARY_NAME="coinote-graper-${{ matrix.rust-target }}"
            OUTPUT_NAME="coinote-graper"
          elif [[ "${{ matrix.platform }}" == "windows-latest" ]]; then
            export GOOS=windows
            export GOARCH=amd64
            BINARY_NAME="coinote-graper-x86_64-pc-windows-msvc.exe"
            OUTPUT_NAME="coinote-graper.exe"
          else
            GOOS=linux
            GOARCH=amd64
            BINARY_NAME="coinote-graper-x86_64-unknown-linux-gnu"
            OUTPUT_NAME="coinote-graper"
          fi

          echo "Building: GOOS=$GOOS GOARCH=$GOARCH OUTPUT=$OUTPUT_NAME"

          go build -trimpath -ldflags "-s -w" -o "$OUTPUT_NAME" ./cmd/server || {
            echo "Go build failed"
            exit 1
          }

          if [[ ! -f "$OUTPUT_NAME" ]]; then
            echo "Build output not found: $OUTPUT_NAME"
            exit 1
          fi

          mkdir -p ../tauri/binaries
          cp "$OUTPUT_NAME" "../tauri/binaries/$BINARY_NAME"
          [[ "$GOOS" != "windows" ]] && chmod +x "../tauri/binaries/$BINARY_NAME" || true

      - uses: tauri-apps/tauri-action@v0.5.25
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
          # SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          # SENTRY_ORG: ${{ secrets.SENTRY_ORG }}
          # SENTRY_PROJECT: ${{ secrets.SENTRY_PROJECT }}
          IS_INTEL_MAC: ${{ contains(matrix.args, 'x86_64') }}
          CI: true
        with:
          projectPath: ./
          releaseId: ${{ needs.create-release.outputs.release-id }}
          args: ${{ matrix.args }}
          releaseDraft: true
          includeUpdaterJson: true
          updaterJsonPreferNsis: false

  finalize-release:
    needs: [create-release, build-tauri]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    if: needs.build-tauri.result == 'success'

    steps:
      - uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const releaseId = ${{ needs.create-release.outputs.release-id }}
            const shouldPublish = '${{ github.event.inputs.draft }}' === 'false'

            const { data: assets } = await github.rest.repos.listReleaseAssets({
              owner: 'haiyon',
              repo: 'coinote-release',
              release_id: releaseId
            })

            const hasUpdaterJson = assets.some(a => a.name === 'latest.json')
            if (!hasUpdaterJson) {
              core.warning('latest.json not found - updates may not work')
            }

            if (shouldPublish) {
              await github.rest.repos.updateRelease({
                owner: 'haiyon',
                repo: 'coinote-release',
                release_id: releaseId,
                draft: false
              })
              core.notice('Release published: https://github.com/haiyon/coinote-release/releases')
            } else {
              core.notice('Draft release ready for review: https://github.com/haiyon/coinote-release/releases')
            }
