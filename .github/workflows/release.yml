name: Release

on:
  repository_dispatch:
    types: [on-demand-release]
  workflow_dispatch:
    inputs:
      sha:
        description: "Commit SHA to build from the source repository"
        required: true
        type: string
      draft:
        description: "Create as draft release"
        required: false
        default: true
        type: boolean

# Ensure only one release workflow runs at a time
concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: false

jobs:
  create-release:
    runs-on: ubuntu-latest
    outputs:
      release-id: ${{ steps.create-release.outputs.result }}
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Checkout source repository
        uses: actions/checkout@v4
        with:
          repository: haiyon/coinote
          token: ${{ secrets.GH_TOKEN_FOR_CHECKOUT }}
          ref: ${{ github.event.inputs.sha || github.event.client_payload.sha }}

      - name: Extract version from package.json
        id: version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "üì¶ Building version: $VERSION"

      - name: Create GitHub Release
        id: create-release
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const version = '${{ steps.version.outputs.version }}'
            const isDraft = ${{ github.event.inputs.draft || 'true' }}

            try {
              const { data: release } = await github.rest.repos.createRelease({
                owner: 'haiyon',
                repo: 'coinote-release',
                tag_name: `v${version}`,
                name: `Coinote v${version}`,
                body: `Download the installer for your platform below.\n\nFor release notes and installation instructions, visit [coinote.app/releases](https://coinote.app/releases).`,
                draft: isDraft,
                prerelease: false,
                target_commitish: 'main'
              })

              console.log(`‚úÖ Release created: ${release.html_url}`)
              return release.id
            } catch (error) {
              core.setFailed(`Failed to create release: ${error.message}`)
            }

  build-tauri:
    needs: create-release
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: macos-latest
            args: "--target aarch64-apple-darwin"
            name: macOS Apple Silicon
            rust-target: aarch64-apple-darwin
          - platform: macos-latest
            args: "--target x86_64-apple-darwin"
            name: macOS Intel
            rust-target: x86_64-apple-darwin
          - platform: windows-latest
            args: ""
            name: Windows x64
            rust-target: x86_64-pc-windows-msvc

    name: Build ${{ matrix.name }}
    runs-on: ${{ matrix.platform }}

    steps:
      - name: Checkout source repository
        uses: actions/checkout@v4
        with:
          repository: haiyon/coinote
          token: ${{ secrets.GH_TOKEN_FOR_CHECKOUT }}
          ref: ${{ github.event.inputs.sha || github.event.client_payload.sha }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"

      - name: Setup Bun (for scripts)
        uses: oven-sh/setup-bun@v2

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.rust-target }}

      - name: Setup Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: "./tauri -> target"
          key: ${{ matrix.platform }}-${{ matrix.rust-target }}

      - name: Setup Go (for Claw service)
        uses: actions/setup-go@v5
        with:
          go-version: "1.24"
          cache-dependency-path: claw/go.sum

      - name: Install dependencies (Ubuntu only)
        if: matrix.platform == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf

      - name: Install frontend dependencies
        run: npm ci

      - name: Build Claw service
        shell: bash
        working-directory: claw
        env:
          GOPROXY: https://goproxy.cn,direct
          GOTOOLCHAIN: local
        run: |
          # Determine target architecture
          if [[ "${{ matrix.platform }}" == "macos-latest" ]]; then
            if [[ "${{ matrix.rust-target }}" == "aarch64-apple-darwin" ]]; then
              GOARCH=arm64
              BINARY_NAME="claw-aarch64-apple-darwin"
            else
              GOARCH=amd64
              BINARY_NAME="claw-x86_64-apple-darwin"
            fi
            GOOS=darwin
          elif [[ "${{ matrix.platform }}" == "windows-latest" ]]; then
            GOOS=windows
            GOARCH=amd64
            BINARY_NAME="claw-x86_64-pc-windows-msvc.exe"
          else
            GOOS=linux
            GOARCH=amd64
            BINARY_NAME="claw-x86_64-unknown-linux-gnu"
          fi

          echo "Building Claw for $GOOS/$GOARCH -> $BINARY_NAME"

          # Build Claw
          CGO_ENABLED=0 GOOS=$GOOS GOARCH=$GOARCH go build \
            -trimpath \
            -ldflags "-s -w -buildid=" \
            -o "claw" \
            ./cmd/server

          # Create binaries directory and copy with correct naming
          mkdir -p ../tauri/binaries
          if [[ "$GOOS" == "windows" ]]; then
            cp claw.exe "../tauri/binaries/$BINARY_NAME"
          else
            cp claw "../tauri/binaries/$BINARY_NAME"
            chmod +x "../tauri/binaries/$BINARY_NAME"
          fi

          echo "‚úÖ Claw built: tauri/binaries/$BINARY_NAME"

      - name: Build and publish with Tauri
        uses: tauri-apps/tauri-action@v0.5.20
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # Uncomment and configure these for macOS code signing
          # APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          # APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          # APPLE_ID: ${{ secrets.APPLE_ID }}
          # APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
          # APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
          # Uncomment for Sentry integration
          # SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          # SENTRY_ORG: ${{ secrets.SENTRY_ORG }}
          # SENTRY_PROJECT: ${{ secrets.SENTRY_PROJECT }}
          IS_INTEL_MAC: ${{ contains(matrix.args, 'x86_64') }}
          CI: true
          NODE_OPTIONS: "--max_old_space_size=4096"
        with:
          projectPath: ./
          releaseId: ${{ needs.create-release.outputs.release-id }}
          args: ${{ matrix.args }}

  update-release-notes:
    needs: [create-release, build-tauri]
    runs-on: ubuntu-latest
    if: always() && needs.create-release.result == 'success'

    steps:
      - name: Update release with build status
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const releaseId = ${{ needs.create-release.outputs.release-id }}
            const version = '${{ needs.create-release.outputs.version }}'
            const buildSuccess = '${{ needs.build-tauri.result }}' === 'success'

            let body = buildSuccess
              ? `Download the installer for your platform below.\n\nFor release notes and installation instructions, visit [coinote.app/releases](https://coinote.app/releases).`
              : `‚ö†Ô∏è Some builds failed. Please check the workflow logs.\n\nFor more information, visit [coinote.app/releases](https://coinote.app/releases).`

            await github.rest.repos.updateRelease({
              owner: 'haiyon',
              repo: 'coinote-release',
              release_id: releaseId,
              body: body
            })

            console.log('‚úÖ Release notes updated')
